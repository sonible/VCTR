<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VCTR: PlatformVectorOps</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="sonible_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">VCTR
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_include_vctr_PlatformVectorOps_Readme.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">PlatformVectorOps </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>PlatformVectorOps is a generic name for third-party, platform optimized vector math operations. At the moment we particularly use functions from the Apple Accelerate Framework and from the Intel IPP library.</p>
<p>Both, Accelerate and IPP are not available on all systems. For Apple, we assume that Accelerate is generally available, the CMake target already links against it. If IPP should be used, the user has to specify <code>VCTR_HAS_IPP</code> and ensure that IPP headers are available on the search path and that we link against it properly.</p>
<p>PlatformVectorOp functions are wrapped behind a struct template, which is empty by default, but have specializations for the datatype for which they are available. These specializations are wrapped in <code>#if</code> blocks so that they are only available if the platform we build for supports them. Using this approach of an empty default struct and specializations, we can reference the struct in code without needing to wrap that code into <code>#if</code> sections, we only need to ensure that the relevant functions are not available in case there is no matching operation by constraining them via concepts. Let's take the <code>AppleAccelerate</code> implementation as an example:</p>
<div class="fragment"><div class="line"> {C++}</div>
<div class="line">namespace vctr::PlatformVectorOps</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">template &lt;class T&gt;</div>
<div class="line">struct AppleAccelerate</div>
<div class="line">{};</div>
<div class="line"> </div>
<div class="line">#if VCTR_APPLE</div>
<div class="line"> </div>
<div class="line">template &lt;&gt;</div>
<div class="line">struct AppleAccelerate&lt;float&gt;</div>
<div class="line">{</div>
<div class="line">    //==============================================================================</div>
<div class="line">    // vForce functions</div>
<div class="line">    //==============================================================================</div>
<div class="line">    static void abs (const float* src, float* dst, int len)                        { vvfabsf (dst, src, &amp;len); }</div>
<div class="line">    //... some more</div>
<div class="line">    </div>
<div class="line">    //==============================================================================</div>
<div class="line">    // vDSP functions</div>
<div class="line">    //==============================================================================</div>
<div class="line">    static void add (const float* srcA, const float* srcB, float* dst, size_t len) { vDSP_vadd (srcA, 1, srcB, 1, dst, 1, len); }</div>
<div class="line">    static void add (const float* srcA, float srcB,        float* dst, size_t len) { vDSP_vsadd (srcA, 1, &amp;srcB, dst, 1, len); }</div>
<div class="line">    static void sub (const float* srcA, const float* srcB, float* dst, size_t len) { vDSP_vsub (srcA, 1, srcB, 1, dst, 1, len); }</div>
<div class="line">    static void mul (const float* srcA, const float* srcB, float* dst, size_t len) { vDSP_vmul (srcA, 1, srcB, 1, dst, 1, len); }</div>
<div class="line">    static void mul (const float* srcA, float srcB,        float* dst, size_t len) { vDSP_vsmul (srcA, 1, &amp;srcB, dst, 1, len); }</div>
<div class="line">    static void div (const float* srcA, const float* srcB, float* dst, size_t len) { vDSP_vdiv (srcA, 1, srcB, 1, dst, 1, len); }</div>
<div class="line">    static void div (const float* srcA, float srcB,        float* dst, size_t len) { vDSP_vsdiv (srcA, 1, &amp;srcB, dst, 1, len); }</div>
<div class="line">    //... some more</div>
<div class="line">};</div>
<div class="line">    </div>
<div class="line">//... some further specializations for other types</div>
<div class="line">#endif</div>
</div><!-- fragment --><p>We see, that the template specialization acts as a very thin wrapper around the functions which are available by the framework. E.g. functions from vForce take signed <code>int</code> length arguments while functions taken from vDSP take <code>size_t</code> length arguments, so we forward them accordingly. vDSP offers functions for adding, multiplying and dividing a vector to/by a scalar but non for subtracting a subtracting a scalar from a vector. Therefore, we only have a single <code>sub</code> overload but multiple ones for the other three operations. Still we apply a few common adoptions, e.g. the stride values for vDSP functions are always hard coded to 1, and the pointer to the size argument required by vForce is converted to a by-value argument in the wrapper.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Using them in expressions</h1>
<p>Before continuing here, you should have understood the general ideas of how to write Expression templates. The relevant documentation is found <a class="el" href="md_include_vctr_Expressions_Readme.html">here</a>.</p>
<p>As described above, we have to take care that the platform specific operations are only invoked in case they are supported on the platform we are building for. Let's have a look at how the <code>Abs</code> expression uses the Accelerate abs operation:</p>
<div class="fragment"><div class="line"> {C++}</div>
<div class="line">const ReturnElementType* evalNextVectorOpInExpressionChain (ReturnElementType* dst) const</div>
<div class="line">requires (platformApple &amp;&amp; has::evalNextVectorOpInExpressionChain&lt;SrcType, ReturnElementType&gt; &amp;&amp; is::realFloatNumber&lt;ReturnElementType&gt;)</div>
<div class="line">{</div>
<div class="line">    AccelerateRetType::abs (src.evalNextVectorOpInExpressionChain (dst), dst, sizeToInt (size()));</div>
<div class="line">    return dst;</div>
<div class="line">}</div>
</div><!-- fragment --><p>We see that the first constraint is <code>platformApple</code> – this way, we would disable that function overload if we are building for a non-apple platform where the corresponding struct would be an empty dummy struct. Then, after checking if the source allows to evaluate vector ops, we check if the data type matches – Accelerate defines functions for <code>float</code> and <code>double</code> so we constrain it to <code>is::realFloatNumber</code>. This way, we can be sure that this code path is only taken if we are evaluating abs for float or double on Apple.</p>
<p>Now if this should also use IPP on x64 CPUs in case of non-apple, we could add another overload with different constraints like this:</p>
<div class="fragment"><div class="line"> {C++}</div>
<div class="line">const ReturnElementType* evalNextVectorOpInExpressionChain (ReturnElementType* dst) const</div>
<div class="line">requires (hasIPP &amp;&amp; ! platformApple &amp;&amp; has::evalNextVectorOpInExpressionChain&lt;SrcType, ReturnElementType&gt; &amp;&amp; is::realFloatNumber&lt;ReturnElementType&gt;)</div>
<div class="line">{</div>
<div class="line">    IPPRetType::abs (src.evalNextVectorOpInExpressionChain (dst), dst, sizeToInt (size()));</div>
<div class="line">    return dst;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Safe int casting</h1>
<p><code><a class="el" href="classvctr_1_1Vector.html" title="The heap-allocated container type.">vctr::Vector</a></code> uses <code>size_t</code> types for sizes, which is the de-facto standard library standard. Some platform specific implementations however use <code>int</code> as the size types. In nearly every case, the range of a 32 bit integer should be all you need. Still, we are able to generate vectors of sizes that exceed the range of an <code>int</code>. To catch such rare edge cases, use the <code>sizeToInt</code> function rather than a direct cast. It will warn the user via assertion in case the cast will likely produce a dangerous truncation. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
